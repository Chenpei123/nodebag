{"version":3,"sources":["../src/perm.js"],"names":["app","factory","permName","HttpService","User","$q","HttpSetting","isInit","deferred","defer","then","data","get","principal","slice","length","d","forEach","add","e","resourceUrl","isMajorData","resourceCode","resolve","reject","catch","console","log","promise","UserPerm","arr","setArr","rejectArr","j","hasOwnProperty","r","find","splice","directive","$http","restrict","scope","link","$scope","element","attr","permData","resourceCodes","eval","indexOf","permCode","css","display","ngClick","nextUrl","clickName","trim","split","tmp"],"mappings":"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","file":"perm.js","sourcesContent":["export default function (app) {\r\n    app.factory('UserPerm', ['permName', 'HttpService', 'User', '$q', 'HttpSetting', function (permName, HttpService, User, $q, HttpSetting) {\r\n        let isInit = false,\r\n            deferred = $q.defer();\r\n\r\n        User.then(({\r\n            data\r\n        }) => {\r\n            HttpService.get('cupid/loadPermissionByPlatform/' + data.principal + permName.slice(0, permName.length - 1)).then(d => {\r\n                isInit = true\r\n                d.forEach(e => {\r\n                    HttpSetting.add(e.resourceUrl, {\r\n                        isMajorData: 0,\r\n                        resourceCode: e.resourceCode\r\n                    })\r\n                })\r\n                deferred.resolve(d)\r\n            }, d => {\r\n                deferred.reject(d)\r\n            }).catch(e => {\r\n                console.log(e)\r\n            })\r\n        }, () => {\r\n            deferred.reject()\r\n        }).catch(e => {\r\n            console.log(e)\r\n        })\r\n        return deferred.promise\r\n    }])\r\n\r\n    //Json权限\r\n    app.factory('JsonPerm', ['UserPerm', function (UserPerm) {\r\n        return function (arr) {\r\n            return UserPerm.then(setArr, rejectArr).catch(e => {\r\n                console.log(e)\r\n            })\r\n\r\n            function setArr(d) {\r\n                for (var j = 0; j < arr.length; j++) {\r\n                    if (arr[j].hasOwnProperty('resourceCode')) {\r\n                        let r = d.find(e => {\r\n                            return e.resourceCode === arr[j].resourceCode\r\n                        })\r\n                        if (!r) {\r\n                            arr.splice(j--, 1);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            function rejectArr(d) {\r\n                for (var j = 0; j < arr.length; j++) {\r\n                    if (arr[j].hasOwnProperty('resourceCode')) {\r\n                        arr.splice(j--, 1);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }])\r\n\r\n    app.directive('permCode', ['$http', 'HttpSetting', 'UserPerm', function ($http, HttpSetting, UserPerm) {\r\n        return {\r\n            restrict: 'A',\r\n            scope: false,\r\n            link: function ($scope, element, attr) {\r\n                if (attr.permData) {\r\n                    //数据权限\r\n                    let resourceCodes = eval(`$scope.${attr.permData}.resourceCodes`)\r\n                    if (resourceCodes && resourceCodes.indexOf(attr.permCode) === -1) {\r\n                        element.css({\r\n                            display: 'none'\r\n                        })\r\n                    }\r\n\r\n                    if (attr.ngClick) {\r\n                        let nextUrl = eval(`$scope.${attr.permData}.permissionInfos && $scope.${attr.permData}.permissionInfos.${attr.permCode}`)\r\n                        if (nextUrl) {\r\n                            let clickName = attr.ngClick.trim().split('(')[0]\r\n                            let tmp = `\r\n                                $scope.${clickName}=(function(self,{entityTypeName,entityId,isMajorData},attr, HttpSetting,nextUrl){\r\n                                    return function(){\r\n                                        HttpSetting.add(nextUrl, {\r\n                                            entityTypeName,\r\n                                            entityId,\r\n                                            isMajorData,\r\n                                            resourceCode:attr.permCode\r\n                                        })\r\n                                        self.apply(null,arguments)\r\n                                    }\r\n                                })($scope.${clickName},$scope.${attr.permData},attr,HttpSetting,nextUrl)`\r\n                            eval(tmp)\r\n                        }\r\n                    }\r\n                } else {\r\n                    //控制权限\r\n                    element.css({\r\n                        display: 'none'\r\n                    })\r\n                    UserPerm.then(d => {\r\n                        d.forEach(e => {\r\n                            if (e.resourceCode === attr.permCode) {\r\n                                element.css({\r\n                                    display: ''\r\n                                })\r\n                            }\r\n                        })\r\n                    }, d => {\r\n                        console.log(d)\r\n                    }).catch(e => {\r\n                        console.log(e)\r\n                    })\r\n                }\r\n            }\r\n        }\r\n    }]);\r\n}"]}