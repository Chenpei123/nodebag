{"version":3,"sources":["../src/load.js"],"names":["toStateCache","fromStateCache","cssToBeEnableList","addResolve","obj","resolve","css","$q","$state","deferred","defer","cssUrl","csslink","document","createElement","setAttribute","name","addEventListener","styleSheet","sheet","disabled","push","head","appendChild","promise","mockFn","old","arguments","call","removeCssList","sameName","exceptFile","exceptArr","split","exceptStr","exceptName","forEach","e","links","querySelectorAll","i","link","length","removeChild","r","every","dataset","getSameStateName","toState","fromState","toStateName","fromStateName","result","cssLoad","app","run","$rootScope","LoginService","$window","$on","event","toParams","fromParams","options","viewConfig","pop"],"mappings":"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","file":"load.js","sourcesContent":["let toStateCache, fromStateCache, cssToBeEnableList = []\r\n\r\nfunction addResolve(obj) {\r\n    Object.assign(obj, {\r\n        resolve: {\r\n            ...obj.resolve,\r\n            css: ['$q', '$state', ($q, $state) => {\r\n                var deferred = $q.defer();\r\n\r\n                if (obj.cssUrl) {\r\n                    let csslink = document.createElement('link')\r\n                    csslink.setAttribute('rel', 'stylesheet')\r\n                    csslink.setAttribute('type', 'text/css')\r\n                    csslink.setAttribute('href', obj.cssUrl)\r\n                    csslink.setAttribute('data-name', obj.name)\r\n                    csslink.addEventListener('load', e => {\r\n                        let styleSheet = csslink.sheet || csslink.styleSheet;\r\n                        //如果可以在加载css文件的同时disabled，应该可以避免闪烁\r\n                        styleSheet.disabled = true\r\n                        cssToBeEnableList.push((sheet => {\r\n                            return function () {\r\n                                sheet.disabled = false\r\n                            }\r\n                        })(styleSheet))\r\n                        deferred.resolve()\r\n                    })\r\n                    document.head.appendChild(csslink)\r\n                } else {\r\n                    deferred.resolve()\r\n                }\r\n\r\n                return deferred.promise;\r\n            }]\r\n        }\r\n    })\r\n    return obj\r\n}\r\n\r\nfunction mockFn(obj, name) {\r\n    let old = obj[name]\r\n    obj[name] = function () {\r\n        arguments[1].name = arguments[0]\r\n        return old.call(obj, arguments[0], addResolve(arguments[1]))\r\n    }\r\n}\r\n\r\n/**\r\n * \r\n */\r\nfunction removeCssList(sameName, exceptFile) {\r\n    let exceptArr = exceptFile.split('.'),\r\n        exceptStr = '',\r\n        exceptName = ''\r\n\r\n    exceptArr.forEach(e => {\r\n        exceptName += exceptName ? '.' + e : e\r\n        exceptStr += ':not([data-name=\"' + exceptName + '\"])'\r\n    })\r\n    let links = document.querySelectorAll('head>link[data-name]' + exceptStr)\r\n    for (let i = 0; i < links.length; i++) {\r\n        let link = links[i]\r\n\r\n        if (sameName.length === 0) {\r\n            document.head.removeChild(link)\r\n        } else {\r\n            let name = ''\r\n            let r = sameName.every(e => {\r\n                name += name ? '.' + e : e\r\n                if (name !== link.dataset.name) {\r\n                    return true\r\n                }\r\n            })\r\n            if (r)\r\n                document.head.removeChild(link)\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * get the same part between toState.name and fromState.name\r\n */\r\nfunction getSameStateName(toState, fromState) {\r\n    let toStateName = toState.name.split('.'),\r\n        fromStateName = fromState.name.split('.'),\r\n        result = []\r\n\r\n    for (let i = 0; i < toStateName.length; i++) {\r\n        if (toStateName[i] === fromStateName[i]) {\r\n            result.push(toStateName[i])\r\n        } else\r\n            break\r\n    }\r\n    return result\r\n}\r\n\r\nfunction cssLoad(app) {\r\n    app.run(['$rootScope', 'LoginService', '$window', ($rootScope, LoginService, $window) => {\r\n        $rootScope.$on('$stateChangeStart', function (event, toState, toParams, fromState, fromParams, options) {\r\n            toStateCache = toState\r\n            fromStateCache = fromState\r\n        })\r\n\r\n        //be careful, the time of removing css file is important, or the screen view would be flashing\r\n        $rootScope.$on('$viewContentLoaded', function (event, viewConfig) {\r\n            if (!toStateCache || !fromStateCache) return\r\n            let sameName = getSameStateName(toStateCache, fromStateCache)\r\n            let exceptName = toStateCache.name || ''\r\n            removeCssList(sameName, exceptName)\r\n            for (let i = 0; i < cssToBeEnableList.length; i++) {\r\n                cssToBeEnableList.pop()()\r\n            }\r\n        })\r\n    }])\r\n}\r\n\r\nexport {\r\n    cssLoad,\r\n    mockFn\r\n}"]}